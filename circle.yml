machine:
  php:
    version: 7.0.4
  environment:
    PATH: ${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/vendor/bin
dependencies:
  cache_directories:
    - "~/.composer/cache"
  pre:
    - pecl install mongodb
    - echo "extension = mongodb.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  override:
    - composer global require "fxp/composer-asset-plugin:~1.1.1"
    - composer install --dev --prefer-dist --no-interaction
    - ./init --env=Development
    - sed -i s/root/ubuntu/ common/config/main-local.php
    - cd tests/codeception/common && codecept build
    - cd tests/codeception/console && codecept build
    - cd tests/codeception/backend && codecept build
    - cd tests/codeception/frontend && codecept build
database:
  override:
    - mysql -e 'CREATE DATABASE feriados_test;'
    - cd tests/codeception/bin && php yii migrate --interactive=0
test:
  override:
    - php -S localhost:8080 > phpserver.log 2>&1
      background: true
    - cd tests && codecept run