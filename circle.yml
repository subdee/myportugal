machine:
  php:
    version: 7.0.4
  services:
    - mongodb
  environment:
    PATH: ${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/vendor/bin
dependencies:
  cache_directories:
    - "~/.composer/cache"
  pre:
    - pecl install mongodb
    - echo "extension = mongodb.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  override:
    - composer global require "fxp/composer-asset-plugin:~1.1.1"
    - composer install --dev --prefer-dist --no-interaction
    - ./init --env=Development
    - sed -i s/root/travis/ common/config/main-local.php
    - cd tests/codeception/common && codecept build
    - cd ../console && codecept build
    - cd ../backend && codecept build
    - cd ../frontend && codecept build
    - cd ../../../
database:
  override:
    - mysql -e 'CREATE DATABASE feriados_test;'
    - cd tests/codeception/bin && php yii migrate --interactive=0 && cd ../../..
test:
  override:
    - php -S localhost:8080 > phpserver.log 2>&1 &
    - cd tests
    - codecept run